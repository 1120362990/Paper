# 应急的基本流程

注意在整个过程中不要被客户或现场的运维人员误导。  
操作前需先征得客户许可。  
因实际的应急情况会比较复杂，因此需根据实际情况进行灵活处置。

## 1.了解情况

1. 发生时间：询问客户发现异常事件的具体时间，后续的操作要基于此时间点进行追踪分析。
2. 受影响系统类型：询问具体的操作系统类型及相关情况，以便后续的应急处置。
    - windows/linux
    - 财务系统/OA系统/官网，系统重要性，是否可关停
    - 是否有弱口令，远程管理端口是否开放
    - 都开放了什么端口，有什么服务，服务是否存在风险性
    - 必要的话现场检测，不要完全相信听来的东西
3. 异常情况：
    - 文件被加密
    - 设备无法正常启动
    - 勒索信息展示
    - CPU利用率过高
    - 网页挂马/黑链
    - 对外发送异常请求
    - 等非正常的情况
4. 已有的处置措施：
    - 之前是否存在此类问题
    - 是否在出现问题后配置了新的策略
    - 是否已有第三方已进行了应急处理，处理结果是什么
    - 是否有其他处置措施
5. 系统架构/网络拓扑：是否能提供网络拓扑图
6. 能否提供以下日志
    - 服务器日志
    - 应用日志，重点web日志
    - 数据库日志
7. 已有的安全设备
    - 终端杀软
    - 防火墙
    - WAF
    - 流量分析设备
8. 基本的应急处置方案
    - 临时处置方案
    - 勒索病毒处置方案
    - 挖矿程序处置预案
    - 网页挂马处置预案
    - DDOS处置预案
    - 内部数据泄露处置预案
    - 其他处置预案

## 2. 遏制传播风险

- 禁止被感染主机使用U盘，移动硬盘。如必须使用做好备份
- 禁用所有无线/有线网卡或直接拔网线
- 关闭相关端口
- 划分隔离网络区域
- 封存主机，相关数据备份
- 被感染主机应用服务下线
- 被感染主机部分功能暂停
- 被感染主机相关账号降权

## 3.已知高危漏洞排查

- 可与下面的步骤同时进行，扫描高危漏洞。但要注意扫描产生的大量日志不要影响漏洞排查

## 4.系统基本信息

- Windows
    1. 查看当前系统的补丁信息  `systeminfo`

## 5.异常连接排查

- Windows
    1. 查看目前的网络连接，定位可疑的 ESTABLISHED  `netstat -ano`

        ```cmd
        netstat -ano | findstr ESTABLISH

        参数说明：
        -a  显示所有网络连接、路由表和网络接口信息
        -n  以数字形式显示地址和端口号
        -o  显示与每个连接相关的所属进程 ID
        -r  显示路由表
        -s  显示按协议统计信息、默认地、显示 IP
        LISTENING      侦听状态
        ESTABLISHED    建立连接
        CLOSE_WAIT     对方主动关闭连接或网络异常导致连接中断
        ```

## 6.正在运行的异常进程排查

- Windows
    1. 查看异常进程  `任务管理器`
    2. 显示运行在本地或远程计算机上的所有进程  `tasklist | findstr 11223`

        ```txt
        根据netstat定位出的异常进程的pid，再通过tasklist命令进行进程定位
        ```

    3. 根据 wmic process 获取进程的全路径  `wmic process | findstr "xx.exe"`

## 7.异常账号排查

- Windows
    1. 图形化界面查看当前的账户和用户组  `lusrmgr.msc`
    2. 查看当前账户情况  `net user`
    3. 查看某个账户的详细信息  `net user Guest`
    4. 查看当前组的情况  `net localgroup administrators`
    5. 查看当前系统会话，比如查看是否有人使用远程终端登陆服务器  `query user`

        ```txt
        踢出该用户  `logoff ID`  ID是上面查询出来的。也可能是用户名
        ```

## 8.异常文件分析

- Windows
    1. 查看文件时间 `右键查看文件属性，查看文件时间`
    2. Recent 是系统文件夹，里面存放着你最近使用的文档的快捷方式，查看用 户 recent 相关文件，通过分析最近打开分析可疑文件  `%UserProfile%\Recent`
    3. 通过文件时间属性来定位可疑文件:根据文件夹内文件列表时间进行排序，查找可疑文件。当然也可以搜索指 定日期范围的文件及文件 查看文件时间，创建时间、修改时间、访问时间，黑客通过菜刀类工具改 变的是修改时间。所以如果修改时间在创建时间之前明显是可疑文件 

## 9.启动项排查

- Windows
    1. 查看开机启动有无异常文件  `msconfig`

## 10.计划任务排查(定时任务)

- Windows
    1. 查看Windows 计划任务  `taskschd.msc`

        ```txt
        或者  【程序】➜【附件】➜【系统工具】➜【任务计划程序】
        ```

## 11.日志排查

- Windows
    1. 打开日志管理器  `eventvwr.msc`

## 12.恢复阶段

- 此阶段以客户为主，仅提供建议

1. webshell/异常文件清除
    - 相关样本取样截图留存
2. 恢复网络
3. 应用功能恢复
4. 补丁升级
5. 提供安全加固措施，推荐切合的安全产品

## 13.跟踪总结

1. 分析事件原因
    - 攻击来源，IP
    - 攻击行为分析，弱口令、可以导致命令执行的漏洞等
2. 输出应急报告
3. 事后观察
4. 提供加固建议

## 附1

1. 处理前先kill掉病毒进程，避免插入的U盘被加密
2. 如果日志分析阶段遇到困难，可对代码进行webshell查杀，可能会有惊喜